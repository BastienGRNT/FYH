{% extends "layout.html.twig" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1>Prochains Hackathons</h1>
            <p class="lead">Trouvez l'√©v√©nement qui va changer votre carri√®re.</p>

            <input type="text" id="search" class="form-control w-50 mx-auto" placeholder="Rechercher un √©v√©nement...">
        </div>
    </div>

    <div class="row" id="hackathon-list">
        {% for h in hackathons %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="{{ h.photo_url ? h.photo_url : 'https://via.placeholder.com/300x150' }}" class="card-img-top" alt="{{ h.nom }}">

                    <div class="card-body">
                        <h5 class="card-title">${escapeHTML(h.nom)}</h5>
                        <p class="card-text text-truncate">${escapeHTML(h.description)}</p>
                        <p class="text-muted">üìÖ {{ h.date_event|date("d/m/Y") }}</p>
                        <p class="fw-bold">{{ h.prix > 0 ? h.prix ~ ' ‚Ç¨' : 'Gratuit' }}</p>

                        <a href="/hackathon?id={{ h.id }}" class="btn btn-primary w-100">Voir d√©tails</a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">Aucun hackathon pr√©vu pour le moment.</div>
        {% endfor %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const escapeHTML = (str) => {
                return str.replace(/[&<>'"]/g,
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag] || tag)
                );
            };

            const searchInput = document.getElementById('search');
            const listContainer = document.getElementById('hackathon-list');

            searchInput.addEventListener('input', async (e) => {
                const term = e.target.value;

                try {
                    const response = await fetch(`/search?q=${encodeURIComponent(term)}`);
                    const hackathons = await response.json();

                    listContainer.innerHTML = '';

                    if (hackathons.length === 0) {
                        listContainer.innerHTML = '<div class="alert alert-info">Aucun √©v√©nement trouv√©.</div>';
                        return;
                    }

                    hackathons.forEach(h => {
                        const dateObj = new Date(h.date_event);
                        const dateStr = dateObj.toLocaleDateString('fr-FR');
                        const prix = h.prix > 0 ? `${h.prix} ‚Ç¨` : 'Gratuit';
                        const img = h.photo_url ? h.photo_url : 'https://via.placeholder.com/300x150';

                        const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <img src="${img}" class="card-img-top" alt="${h.nom}">
                            <div class="card-body">
                                <h5 class="card-title">${h.nom}</h5>
                                <p class="card-text text-truncate">${h.description}</p>
                                <p class="text-muted">üìÖ ${dateStr}</p>
                                <p class="fw-bold">${prix}</p>
                                <a href="/hackathon?id=${h.id}" class="btn btn-primary w-100">Voir d√©tails</a>
                            </div>
                        </div>
                    </div>
                `;
                        listContainer.insertAdjacentHTML('beforeend', card);
                    });
                } catch (error) {
                    console.error("Erreur AJAX :", error);
                }
            });
        });
    </script>
{% endblock %}