name: Deploy to Self-Hosted Runner

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Permissions
        run: |
          sudo chown -R $USER:$USER .

      - name: Install Docker Compose V2
        run: |
          echo "Installation du plugin Docker Compose..."
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin
          # Vérification que ça marche
          docker compose version

      - name: Create Environment Files
        run: |
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
          echo "DB_NAME=fyh_db" >> .env
          echo "DB_USER=fyh_user" >> .env
          
          echo "DB_HOST=db" > php/src/.env
          echo "DB_NAME=fyh_db" >> php/src/.env
          echo "DB_USER=fyh_user" >> php/src/.env
          echo "DB_PASS=${{ secrets.DB_PASSWORD }}" >> php/src/.env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> php/src/.env

      - name: Build and Start Containers
        run: |
          # Maintenant, cette commande va fonctionner
          docker compose up -d --build --remove-orphans

      - name: Install Dependencies
        run: |
          docker exec fyh_php composer install --no-dev --optimize-autoloader --no-interaction

      - name: Run Database Migrations
        run: |
          echo "Waiting for database..."
          sleep 10
          docker exec fyh_php php /var/www/html/database/migrate.php

      - name: Cleanup
        run: |
          docker image prune -f
